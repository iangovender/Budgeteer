{% extends "base.html" %}

{% block title %}Add Expense - Budgeteer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>Add New Expense</h2>
        <p class="text-muted">Track your spending by adding expenses below</p>
    </div>
</div>

<!-- Expense Form -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">Expense Details</h5>
                <form method="POST" action="{{ url_for('expense_entry') }}">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        <label for="date" class="form-label">Date</label>
                        {{ form.date(class="form-control") }}
                        {% if form.date.errors %}
                            <div class="text-danger">
                                {% for error in form.date.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">Amount (R)</label>
                        {{ form.amount(class="form-control", placeholder="0.00") }}
                        {% if form.amount.errors %}
                            <div class="text-danger">
                                {% for error in form.amount.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        {{ form.description(class="form-control", placeholder="What did you spend on?") }}
                        {% if form.description.errors %}
                            <div class="text-danger">
                                {% for error in form.description.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus me-2"></i>Add Expense
                    </button>
                </form>
            </div>
        </div>

        <!-- Category Info Card -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title mb-3"><i class="fas fa-info-circle me-2 text-primary"></i>Auto-Categorization</h6>
                <p class="small text-muted mb-0">
                    Your expenses are automatically categorized based on the description you provide. 
                    The system analyzes keywords to assign the most relevant category.
                </p>
            </div>
        </div>
    </div>

    <!-- All Expenses by Month -->
    <div class="col-md-6">
        <div class="card expenses-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">All Expenses by Month</h5>
                    <span class="badge bg-primary">{{ all_expenses|length }} total</span>
                </div>
                
                {% if all_expenses %}
                <div class="expenses-container">
                    <!-- Month Navigation -->
                    <div class="month-navigation mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm btn-outline-primary month-nav-btn" id="prevMonthBtn">
                                <i class="fas fa-chevron-left me-1"></i>Previous
                            </button>
                            <h6 class="current-month-header text-primary mb-0 mx-3" id="currentMonthHeader">
                                Loading...
                            </h6>
                            <button class="btn btn-sm btn-outline-primary month-nav-btn" id="nextMonthBtn">
                                Next<i class="fas fa-chevron-right ms-1"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Expenses Table Container with Scroll -->
                    <div class="expenses-scrollable-container">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Details</th>
                                    <th>Amount</th>
                                    <th>Category</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody">
                                {% for expense in all_expenses %}
                                <tr class="expense-row" data-month="{{ expense.date.strftime('%Y-%m') }}">
                                    <td style="white-space: nowrap;">{{ expense.date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ expense.description[:30] }}{% if expense.description|length > 30 %}...{% endif %}</td>
                                    <td class="fw-bold">R {{ expense.amount }}</td>
                                    <td>
                                        <span class="badge bg-primary" style="font-size: 0.75rem;">{{ expense.category }}</span>
                                    </td>
                                    <td>
                                        <form method="POST" action="{{ url_for('delete_expense', expense_id=expense.id) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this expense?');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token is defined else '' }}"/>
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Expense">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <!-- No expenses message for current month -->
                        <div id="noExpensesMessage" class="text-center py-4 d-none">
                            <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No expenses for this month.</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No expenses recorded yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set today's date as default
    document.addEventListener('DOMContentLoaded', function() {
        const dateField = document.getElementById('date');
        if (dateField && !dateField.value) {
            dateField.value = new Date().toISOString().split('T')[0];
        }
        
        // Focus on amount field for better UX
        document.getElementById('amount').focus();

        // Month navigation functionality
        const expenseRows = document.querySelectorAll('.expense-row');
        const monthHeader = document.getElementById('currentMonthHeader');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const noExpensesMessage = document.getElementById('noExpensesMessage');
        const expensesTableBody = document.getElementById('expensesTableBody');
        
        if (expenseRows.length === 0) {
            console.log('No expense rows found');
            return;
        }

        console.log('Found', expenseRows.length, 'expense rows');

        // Get all unique months from expenses
        const months = Array.from(expenseRows).map(row => row.getAttribute('data-month'));
        const uniqueMonths = [...new Set(months)].sort().reverse(); // Sort descending (newest first)
        
        console.log('Unique months:', uniqueMonths);
        
        let currentMonthIndex = 0;

        // Function to update displayed month
        function updateDisplayedMonth() {
            const currentMonth = uniqueMonths[currentMonthIndex];
            console.log('Updating to month:', currentMonth, 'Index:', currentMonthIndex);
            
            // Update month header
            const date = new Date(currentMonth + '-01');
            monthHeader.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            // Show/hide expenses based on current month
            let hasExpenses = false;
            expenseRows.forEach(row => {
                if (row.getAttribute('data-month') === currentMonth) {
                    row.style.display = 'table-row';
                    hasExpenses = true;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show/hide no expenses message and table
            if (hasExpenses) {
                noExpensesMessage.classList.add('d-none');
                expensesTableBody.style.display = 'table-row-group';
            } else {
                noExpensesMessage.classList.remove('d-none');
                expensesTableBody.style.display = 'none';
            }
            
            // Update button states
            prevMonthBtn.disabled = currentMonthIndex >= uniqueMonths.length - 1;
            nextMonthBtn.disabled = currentMonthIndex <= 0;
            
            console.log('Prev disabled:', prevMonthBtn.disabled, 'Next disabled:', nextMonthBtn.disabled);
            
            // Add visual feedback for disabled buttons
            prevMonthBtn.classList.toggle('btn-disabled', prevMonthBtn.disabled);
            nextMonthBtn.classList.toggle('btn-disabled', nextMonthBtn.disabled);
        }

        // Previous month button click
        prevMonthBtn.addEventListener('click', function() {
            if (!this.disabled && currentMonthIndex < uniqueMonths.length - 1) {
                currentMonthIndex++;
                console.log('Previous clicked, new index:', currentMonthIndex);
                updateDisplayedMonth();
            }
        });

        // Next month button click
        nextMonthBtn.addEventListener('click', function() {
            if (!this.disabled && currentMonthIndex > 0) {
                currentMonthIndex--;
                console.log('Next clicked, new index:', currentMonthIndex);
                updateDisplayedMonth();
            }
        });

        // Initialize with current month (most recent)
        updateDisplayedMonth();
    });
</script>

<style>
/* Fixed height for expenses card */
.expenses-card {
    height: 650px;
}

.expenses-card .card-body {
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 1.25rem;
}

.expenses-container {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    overflow: hidden;
}

.expenses-scrollable-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    min-height: 0;
}

.expenses-scrollable-container::-webkit-scrollbar {
    width: 10px;
}

.expenses-scrollable-container::-webkit-scrollbar-track {
    background: #f7fafc;
    border-radius: 4px;
}

.expenses-scrollable-container::-webkit-scrollbar-thumb {
    background-color: #cbd5e0;
    border-radius: 4px;
    border: 2px solid #f7fafc;
}

.expenses-scrollable-container::-webkit-scrollbar-thumb:hover {
    background-color: #a0aec0;
}

.month-navigation {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #42a5f5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    flex-shrink: 0;
}

.current-month-header {
    font-weight: 700;
    margin: 0;
    font-size: 1.1rem;
    color: #1e88e5 !important;
}

.month-nav-btn {
    border-radius: 20px;
    padding: 6px 16px;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid #42a5f5;
    color: #42a5f5;
    background-color: white;
}

.month-nav-btn:not(.btn-disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(66, 165, 245, 0.3);
    background-color: #42a5f5;
    color: white;
}

.month-nav-btn.btn-disabled {
    opacity: 0.4;
    cursor: not-allowed;
    border-color: #ccc;
    color: #ccc;
    background-color: #f8f9fa;
}

.month-nav-btn.btn-disabled:hover {
    transform: none;
    box-shadow: none;
    background-color: #f8f9fa;
    color: #ccc;
}

.table {
    border-collapse: separate;
    border-spacing: 0;
    margin-bottom: 0 !important;
}

.table th {
    font-size: 0.8rem;
    font-weight: 600;
    background-color: #1e88e5;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
    border: none;
    padding: 12px 8px;
}

.table thead th:first-child {
    border-top-left-radius: 8px;
}

.table thead th:last-child {
    border-top-right-radius: 8px;
}

.table td {
    font-size: 0.85rem;
    vertical-align: middle;
    border-bottom: 1px solid #e9ecef;
    padding: 10px 8px;
}

.expense-row {
    transition: all 0.2s ease;
}

.expense-row:hover {
    background-color: #f1f9ff;
    transform: translateX(2px);
}
</style>
{% endblock %}