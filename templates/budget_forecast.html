{% extends "base.html" %}

{% block title %}Budget Forecast - Budgeteer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>Budget Forecast</h2>
        <p class="text-muted">Predict your future spending and plan ahead with budget insights.</p>
    </div>
</div>

<!-- Forecast Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card border-primary h-100">
            <div class="card-body text-center">
                <div class="text-primary mb-3">
                    <i class="fas fa-chart-line fa-2x"></i>
                </div>
                <h5 class="card-title">Projected Spending</h5>
                <h3 class="text-primary">R {{ predicted_total | round(2) if predicted_total else 0.00 }}</h3>
                <p class="text-muted small">Estimated monthly total</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-success h-100">
            <div class="card-body text-center">
                <div class="text-success mb-3">
                    <i class="fas fa-bullseye fa-2x"></i>
                </div>
                <h5 class="card-title">Budget Health</h5>
                <h3 class="text-success">{{ budget_health }}</h3>
                <p class="text-muted small">Financial status</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-warning h-100">
            <div class="card-body text-center">
                <div class="text-warning mb-3">
                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                </div>
                <h5 class="card-title">Risk Categories</h5>
                <h3 class="text-warning">{{ risk_areas | length }}</h3>
                <p class="text-muted small">Potential over-budget</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card border-info h-100">
            <div class="card-body text-center">
                <div class="text-info mb-3">
                    <i class="fas fa-lightbulb fa-2x"></i>
                </div>
                <h5 class="card-title">Savings Potential</h5>
                <h3 class="text-info">R {{ predicted_savings | round(2) if predicted_savings else 0.00 }}</h3>
                <p class="text-muted small">Monthly opportunity</p>
            </div>
        </div>
    </div>
</div>

<!-- Chart Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">Spending Forecast vs Actual</h5>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Category Forecasts -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">Category-wise Forecast</h5>
                
                {% if predicted_spending %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Monthly Budget</th>
                                <th>Projected Spending</th>
                                <th>Difference</th>
                                <th>Status</th>
                                <th>Recommendation</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in categories %}
                            {% set budget = budgets.get(category, 0) %}
                            {% set projected = predicted_spending.get(category, 0) %}
                            {% set difference = projected - budget %}
                            <tr>
                                <td class="fw-bold">
                                    <i class="fas fa-tag me-2 text-primary"></i>{{ category }}
                                </td>
                                <td>R {{ budget | round(2) }}</td>
                                <td>R {{ projected | round(2) }}</td>
                                <td>
                                    <span class="fw-bold {% if difference > 0 %}text-danger{% else %}text-success{% endif %}">
                                        R {{ difference | round(2) }}
                                    </span>
                                </td>
                                <td>
                                    {% if difference > 0 %}
                                        <span class="badge bg-danger">Over Budget</span>
                                    {% elif difference >= -budget * 0.1 %}
                                        <span class="badge bg-warning">Close to Limit</span>
                                    {% else %}
                                        <span class="badge bg-success">On Track</span>
                                    {% endif %}
                                </td>
                                <td class="small">
                                    {% if difference > 0 %}
                                        Consider reducing {{ category.lower() }} spending by R {{ (difference * 0.8) | round(2) }}
                                    {% else %}
                                        Good spending control in {{ category.lower() }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No forecast data available</h5>
                    <p class="text-muted">Add more expenses to generate accurate forecasts.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- AI Insights -->
{% if recommendations %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>Budget Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Trend Analysis</h6>
                        <p class="text-muted">{{ trend_indicator }}</p>
                        
                        <h6 class="mt-4">Risk Assessment</h6>
                        <p class="text-muted">
                            {% if risk_areas %}
                                Potential budget risks in: {{ risk_areas | join(', ') }}
                            {% else %}
                                No major budget risks detected
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Smart Recommendations</h6>
                        <ul class="list-group">
                            {% for recommendation in recommendations %}
                            <li class="list-group-item">
                                <i class="fas fa-{{ recommendation.icon }} text-{{ recommendation.type }} me-2"></i>
                                {{ recommendation.suggestion }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if we have forecast data
    const predictedSpending = JSON.parse('{{ predicted_spending | tojson | safe }}');
    const categories = JSON.parse('{{ categories | tojson | safe }}');
    const currentSpending = JSON.parse('{{ current_spending | tojson | safe }}');
    const budgets = JSON.parse('{{ budgets | tojson | safe }}');
    const hasForecastData = predictedSpending && Object.keys(predictedSpending).length > 0;

    if (hasForecastData) {
        const forecastData = {
            labels: categories,
            current: categories.map(category => Number(currentSpending[category] || 0).toFixed(2)),
            predicted: categories.map(category => Number(predictedSpending[category] || 0).toFixed(2)),
            budgets: categories.map(category => Number(budgets[category] || 0).toFixed(2))
        };
        
        const ctx = document.getElementById('forecastChart').getContext('2d');
        const forecastChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: forecastData.labels,
                datasets: [
                    {
                        label: 'Current Month',
                        data: forecastData.current,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Predicted Next Month',
                        data: forecastData.predicted,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Budget Limits',
                        data: forecastData.budgets,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        type: 'line',
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Amount (R)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Categories'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                // context.raw may be a string if .toFixed was used earlier, so ensure it's a number
                                let value = Number(context.raw);
                                return `${context.dataset.label}: R ${value.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

<style>
.chart-container {
    position: relative;
    width: 100%;
}

.card {
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #6c757d;
}

.badge {
    font-size: 0.75em;
}

/* Ensure consistent card heights */
.card.h-100 .card-body {
    display: flex;
    flex-direction: column;
    justify-content: center;
}
</style>
{% endblock %}